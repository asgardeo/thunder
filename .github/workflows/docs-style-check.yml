# This workflow validates that Thunder content follows the style rules defined in .vale.ini using Vale.
# It only runs on changed md and mdx files in pull requests.

name: ü•í Vale Lint (Changed Markdown Only)

on:
  pull_request:
    paths:
      - '**/*.md'
      - '**/*.mdx'

jobs:
  vale:
    name: Vale style check
    runs-on: ubuntu-latest
    permissions:
      contents: read
      checks: write
      pull-requests: read

    steps:
      - name: üì• Checkout Code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: üîç Get changed markdown files
        id: changed-files
        run: |
          # Get list of changed md/mdx files in this PR
          FILES=$(git diff --name-only --diff-filter=ACMR origin/${{ github.base_ref }}...HEAD -- '*.md' '*.mdx')
          if [ -z "$FILES" ]; then
            echo "No markdown files changed."
            echo "has_files=false" >> "$GITHUB_OUTPUT"
          else
            echo "Changed markdown files:"
            echo "$FILES"
            # Convert newline-separated list to comma-separated for vale-action
            COMMA_FILES=$(echo "$FILES" | paste -sd ',' -)
            echo "files=$COMMA_FILES" >> "$GITHUB_OUTPUT"
            echo "has_files=true" >> "$GITHUB_OUTPUT"
          fi

      - name: üîç Run Vale
        if: steps.changed-files.outputs.has_files == 'true'
        uses: errata-ai/vale-action@v2.1.1
        with:
          files: ${{ steps.changed-files.outputs.files }}
          separator: ","
          reporter: github-pr-check
          filter_mode: added
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
